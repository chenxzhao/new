<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词循环朗读系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#6B7280',
                        accent: '#10B981', // 绿色（未播放/暂停状态）
                        running: '#F59E0B', // 橙色（播放中状态）
                        neutral: '#F3F4F6',
                        danger: '#EF4444',
                        wordBg: '#EFF6FF',
                        meaningBg: '#F7F8FA',
                        phoneticBg: '#FAFAFA'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .chapter-active {
                @apply bg-primary text-white;
            }
            .btn-control {
                @apply px-6 py-2 rounded-md transition-all font-medium flex items-center justify-center gap-2;
            }
            .btn-nav {
                @apply px-4 py-2 rounded-full flex items-center justify-center text-gray-700 hover:bg-primary hover:text-white transition-all;
            }
            .btn-danger {
                @apply bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-md transition-all;
            }
            .play-count-active {
                @apply bg-primary text-white border-primary;
            }
            .info-block {
                @apply w-full max-w-md mx-auto p-4 rounded-lg text-center;
            }
            .word-animate {
                animation: wordPulse 0.5s ease-in-out;
            }
            @keyframes wordPulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .modal-enter {
                animation: modalFadeIn 0.3s ease-in-out;
            }
            @keyframes modalFadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- 页面标题 -->
    <header class="bg-white shadow-sm py-4 px-6">
        <h1 class="text-xl md:text-2xl font-bold text-primary flex items-center justify-center">
            <i class="fa fa-volume-up mr-2"></i>单词循环朗读系统
        </h1>
    </header>

    <!-- 主内容区 - 垂直排列并居中 -->
    <main class="flex-1 p-4">
        <!-- 章节选择区 - 居中显示（改为弹窗触发） -->
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6 my-4">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-secondary">当前章节</h2>
                <!-- 显示当前选中的章节 -->
                <span id="currentChapterDisplay" class="text-primary font-medium">--</span>
                <!-- 弹窗触发按钮 -->
                <button id="showChapterBtn" class="text-primary hover:text-primary/80 text-sm flex items-center">
                    <i class="fa fa-list mr-1"></i>选择章节
                </button>
            </div>
        </div>

        <!-- 章节列表弹窗（默认隐藏） -->
        <div id="chapterModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center modal-enter">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md max-h-[80vh] overflow-y-auto m-4">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-secondary">选择章节</h3>
                    <button id="closeChapterModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <ul id="chapterModalList" class="p-4 space-y-1">
                    <!-- 弹窗章节列表将通过JS动态生成 -->
                </ul>
            </div>
        </div>

        <!-- 单词操作区 - 居中显示 -->
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6 my-4">
            <!-- 单词导航与序号 -->
            <div class="text-right text-secondary mb-6 flex justify-between items-center">
                <div class="flex gap-2">
                    <button id="prevWordBtn" class="btn-nav">上一个</button>
                    <button id="nextWordBtn" class="btn-nav">下一个</button>
                </div>
                <span id="wordIndex" class="text-lg font-medium">1/0</span>
            </div>

            <!-- 单词信息展示 -->
            <div class="space-y-4 mb-8">
                <div class="info-block bg-wordBg">
                    <div id="wordText" class="text-[clamp(2rem,7vw,3.5rem)] font-semibold text-gray-800"></div>
                </div>
                <div class="info-block bg-phoneticBg">
                    <div id="wordPhonetic" class="text-[clamp(1rem,2.5vw,1.5rem)] text-primary italic"></div>
                </div>
                <div class="info-block bg-meaningBg">
                    <div id="wordMeaning" class="text-[clamp(1.2rem,3vw,1.8rem)] text-gray-700"></div>
                </div>
            </div>

            <!-- 播放次数设置 + 初始化数据库按钮 -->
            <div class="mb-4">
                <div class="flex flex-wrap justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">播放次数</label>
                    <button id="initDBBtn" class="btn-danger text-sm flex items-center">
                        <i class="fa fa-refresh mr-1"></i>初始化数据库
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button class="play-count-btn px-3 py-1.5 border rounded-md hover:bg-primary/10 transition-colors" data-count="1">1次</button>
                    <button class="play-count-btn px-3 py-1.5 border rounded-md hover:bg-primary/10 transition-colors" data-count="3">3次</button>
                    <button class="play-count-btn px-3 py-1.5 border rounded-md hover:bg-primary/10 transition-colors" data-count="6">6次</button>
                    <button class="play-count-btn px-3 py-1.5 border rounded-md hover:bg-primary/10 transition-colors" data-count="12">12次</button>
                    <button class="play-count-btn px-3 py-1.5 border rounded-md hover:bg-primary/10 transition-colors" data-count="25">25次</button>
                </div>
            </div>

            <!-- 总播放进度提示 -->
            <div class="mb-6 text-center text-gray-600 text-sm">
                <span id="playProgress">当前单词播放进度：0/0</span>
            </div>

            <!-- 合并的控制按钮 -->
            <div class="flex justify-center">
                <button id="controlBtn" class="btn-control bg-accent text-white hover:bg-accent/90">
                    <i class="fa fa-play"></i>
                    <span>开始循环播放</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        // 全局状态管理
        const state = {
            db: null,
            chapters: [],
            currentChapter: '',
            currentChapterWords: [],
            currentWordIndex: 0,
            currentPlayCount: 1,
            tempPlayCount: 1,
            currentWordPlayed: 0,
            isLooping: false,
            speech: null,
            isModalOpen: false // 控制弹窗显示/隐藏
        };

        // 初始化函数
        async function init() {
            state.speech = window.speechSynthesis;
            await openDB();
            
            // 静默清理单词数据（仅chapters表）并写入默认数据
            await silentCleanChaptersData();
            
            // 加载章节
            await loadChapters();
            
            // 恢复上次学习状态
            await restoreLastStudyState();
            
            // 初始化UI状态
            setActivePlayCount(state.currentPlayCount);
            updatePlayProgress();
            updateNavButtonsState();
            updateControlButtonState();
            updateCurrentChapterDisplay(); // 初始化当前章节显示
            
            // 绑定事件
            bindBeforeUnloadEvent();
            bindEvents();
        }

        // 数据库相关函数
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = window.indexedDB.open('WordReaderDB', 2);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('chapters')) {
                        db.createObjectStore('chapters', { keyPath: 'chapterName' });
                    }
                    if (!db.objectStoreNames.contains('studyState')) {
                        db.createObjectStore('studyState', { keyPath: 'id' });
                    }
                };
                
                request.onsuccess = (event) => {
                    state.db = event.target.result;
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error('数据库打开失败:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 静默清理chapters表并写入默认数据
        function silentCleanChaptersData() {
            const defaultChapters = [
                {
                    chapterName: '8.8',
                    words: [
                        {text: "history", phonetic: "ˈhɪstr̩i", meaning: "历史"},
                        {text: "physical education", phonetic: "ˈfɪzɪkl̩ ˌedʒʊˈkeɪʃn̩", meaning: "体育课"},
                        {text: "PE", phonetic: "ˌpiːˈiː", meaning: "体育课"},
                        {text: "mathematics", phonetic: "ˌmæθəˈmætɪks", meaning: "数学"},
                        {text: "finance", phonetic: "ˈfaɪnæns", meaning: "金融学"},
                        {text: "mass media", phonetic: "mæs ˈmiːdɪə", meaning: "大众传媒"},
                        {text: "statistics", phonetic: "stəˈtɪstɪks", meaning: "统计学"},
                        {text: "mining", phonetic: "ˈmaɪnɪŋ", meaning: "采矿"},
                        {text: "engineering", phonetic: "ˌendʒɪˈnɪərɪŋ", meaning: "工程学"},
                        {text: "architecture", phonetic: "ˈɑːkɪtektʃə", meaning: "建筑学"},
                        {text: "fine arts", phonetic: "faɪn ɑːts", meaning: "美术"}
                    ]
                },
                {
                    chapterName: '8.9',
                    words: [
                        {text: "computer science", phonetic: "kəmˈpjuːtə ˈsaɪəns", meaning: "计算机科学"},
                        {text: "biology", phonetic: "baɪˈɒlədʒi", meaning: "生物学"},
                        {text: "chemistry", phonetic: "ˈkemɪstri", meaning: "化学"},
                        {text: "physics", phonetic: "ˈfɪzɪks", meaning: "物理学"},
                        {text: "astronomy", phonetic: "əˈstrɒnəmi", meaning: "天文学"},
                        {text: "geography", phonetic: "dʒiˈɒɡrəfi", meaning: "地理学"},
                        {text: "politics", phonetic: "ˈpɒlətɪks", meaning: "政治学"},
                        {text: "economics", phonetic: "ˌiːkəˈnɒmɪks", meaning: "经济学"},
                        {text: "psychology", phonetic: "saɪˈkɒlədʒi", meaning: "心理学"},
                        {text: "sociology", phonetic: "ˌsəʊsiˈɒlədʒi", meaning: "社会学"},
                        {text: "philosophy", phonetic: "fəˈlɒsəfi", meaning: "哲学"}
                    ]
                }
            ];
            return new Promise((resolve) => {
                const transaction = state.db.transaction('chapters', 'readwrite');
                const store = transaction.objectStore('chapters');
                
                // 先清空现有章节数据
                store.clear().onsuccess = () => {
                    // 再写入默认数据
                    defaultChapters.forEach(chapter => {
                        store.add(chapter);
                    });
                };
                
                transaction.oncomplete = () => resolve();
            });
        }

        async function manualInitDB() {
            const confirmInit = confirm('确定要初始化数据库吗？此操作会覆盖所有现有单词数据！');
            if (!confirmInit) return;
            
            stopLoop();
            await silentCleanChaptersData();
            await loadChapters();
            if (state.chapters.length > 0) {
                await selectChapter(state.chapters[0]);
            }
            alert('数据库已初始化完成');
        }

        // 加载章节列表
        function loadChapters() {
            return new Promise((resolve) => {
                const transaction = state.db.transaction('chapters', 'readonly');
                const store = transaction.objectStore('chapters');
                const request = store.getAllKeys();
                request.onsuccess = () => {
                    state.chapters = request.result;
                    resolve();
                };
            });
        }

        // 打开章节弹窗
        function openChapterModal() {
            state.isModalOpen = true;
            document.getElementById('chapterModal').classList.remove('hidden');
            document.getElementById('chapterModal').classList.add('flex');
            renderChapterModalList(); // 渲染弹窗内的章节列表
        }

        // 关闭章节弹窗
        function closeChapterModal() {
            state.isModalOpen = false;
            document.getElementById('chapterModal').classList.add('hidden');
            document.getElementById('chapterModal').classList.remove('flex');
        }

        // 渲染弹窗内的章节列表
        function renderChapterModalList() {
            const modalListEl = document.getElementById('chapterModalList');
            modalListEl.innerHTML = '';
            state.chapters.forEach(chapterName => {
                const li = document.createElement('li');
                li.className = `px-3 py-2 rounded-md cursor-pointer hover:bg-gray-100 transition-colors ${state.currentChapter === chapterName ? 'chapter-active' : ''}`;
                li.textContent = chapterName;
                li.addEventListener('click', () => {
                    selectChapter(chapterName); // 选择章节
                    closeChapterModal(); // 自动关闭弹窗
                });
                modalListEl.appendChild(li);
            });
        }

        // 更新当前章节显示（非弹窗状态下）
        function updateCurrentChapterDisplay() {
            const displayEl = document.getElementById('currentChapterDisplay');
            displayEl.textContent = state.currentChapter || '未选择';
        }

        // 选择章节
        async function selectChapter(chapterName) {
            stopLoop();
            state.currentChapter = chapterName;
            state.currentWordIndex = 0;
            state.currentWordPlayed = 0;
            
            const chapter = await getChapterData(chapterName);
            state.currentChapterWords = chapter?.words || [];
            
            if (state.currentChapterWords.length > 0) {
                showWord(state.currentChapterWords[0], 0);
            } else {
                clearWordDisplay();
                updateWordIndex(0, 0);
            }
            updatePlayProgress();
            updateNavButtonsState();
            updateCurrentChapterDisplay(); // 更新当前章节显示
        }

        function getChapterData(chapterName) {
            return new Promise((resolve) => {
                const transaction = state.db.transaction('chapters', 'readonly');
                const store = transaction.objectStore('chapters');
                const request = store.get(chapterName);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        }

        // 单词显示相关函数
        function showWord(word, index) {
            document.getElementById('wordText').textContent = word.text || '';
            document.getElementById('wordPhonetic').textContent = word.phonetic || '';
            document.getElementById('wordMeaning').textContent = word.meaning || '';
            updateWordIndex(index + 1, state.currentChapterWords.length);
        }

        function clearWordDisplay() {
            document.getElementById('wordText').textContent = '';
            document.getElementById('wordPhonetic').textContent = '';
            document.getElementById('wordMeaning').textContent = '';
        }

        function updateWordIndex(current, total) {
            document.getElementById('wordIndex').textContent = `${current}/${total}`;
        }

        function updatePlayProgress() {
            const progressEl = document.getElementById('playProgress');
            progressEl.textContent = `当前单词播放进度：${state.currentWordPlayed}/${state.currentPlayCount}`;
        }

        // 更新导航按钮状态
        function updateNavButtonsState() {
            const hasWords = state.currentChapterWords.length > 0;
            const prevBtn = document.getElementById('prevWordBtn');
            const nextBtn = document.getElementById('nextWordBtn');
            
            if (hasWords) {
                prevBtn.removeAttribute('disabled');
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                nextBtn.removeAttribute('disabled');
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.setAttribute('disabled', 'true');
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                nextBtn.setAttribute('disabled', 'true');
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // 上一个单词（循环滚动）
        function goToPrevWord() {
            if (state.currentChapterWords.length === 0) return;
            
            stopLoop();
            const totalWords = state.currentChapterWords.length;
            state.currentWordIndex = (state.currentWordIndex - 1 + totalWords) % totalWords;
            state.currentWordPlayed = 0;
            showWord(state.currentChapterWords[state.currentWordIndex], state.currentWordIndex);
            updatePlayProgress();
        }

        // 下一个单词（循环滚动）
        function goToNextWord() {
            if (state.currentChapterWords.length === 0) return;
            
            stopLoop();
            const totalWords = state.currentChapterWords.length;
            state.currentWordIndex = (state.currentWordIndex + 1) % totalWords;
            state.currentWordPlayed = 0;
            showWord(state.currentChapterWords[state.currentWordIndex], state.currentWordIndex);
            updatePlayProgress();
        }

        // 播放次数设置
        function setActivePlayCount(count) {
            if (state.isLooping) stopLoop();
            state.tempPlayCount = count;
            state.currentPlayCount = count;
            document.querySelectorAll('.play-count-btn').forEach(btn => {
                if (parseInt(btn.dataset.count) === count) {
                    btn.classList.add('play-count-active');
                } else {
                    btn.classList.remove('play-count-active');
                }
            });
            updatePlayProgress();
        }

        // 合并的控制按钮逻辑
        function togglePlayPause() {
            if (state.isLooping) {
                stopLoop();
            } else {
                startLoop();
            }
        }

        // 开始播放
        async function startLoop() {
            if (state.currentChapterWords.length === 0) return;
            
            state.speech.cancel();
            state.isLooping = true;
            state.currentWordPlayed = 0;
            updateControlButtonState();
            updatePlayProgress();
            await loopThroughWords();
        }

        // 停止播放
        function stopLoop() {
            state.speech.cancel();
            state.isLooping = false;
            state.currentWordPlayed = 0;
            updateControlButtonState();
            document.getElementById('wordText').classList.remove('word-animate');
            updatePlayProgress();
        }

        // 循环播放单词
        async function loopThroughWords() {
            while (state.isLooping) {
                if (state.currentChapterWords.length === 0) {
                    state.isLooping = false;
                    updateControlButtonState();
                    return;
                }
                
                const currentWord = state.currentChapterWords[state.currentWordIndex];
                await playWordTotalCounts(currentWord);
                
                if (!state.isLooping) return;
                
                // 自动切换到下一个单词
                state.currentWordIndex = (state.currentWordIndex + 1) % state.currentChapterWords.length;
                state.currentWordPlayed = 0;
                updatePlayProgress();
                showWord(state.currentChapterWords[state.currentWordIndex], state.currentWordIndex);
            }
        }

        // 播放单词指定次数
        function playWordTotalCounts(word) {
            return new Promise((resolve) => {
                if (!word || !word.text || !state.isLooping) {
                    resolve();
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(word.text);
                utterance.lang = 'en-US';
                
                utterance.onstart = () => {
                    const wordTextEl = document.getElementById('wordText');
                    wordTextEl.classList.remove('word-animate');
                    void wordTextEl.offsetWidth;
                    setTimeout(() => wordTextEl.classList.add('word-animate'), 80);
                };
                
                utterance.onend = () => {
                    document.getElementById('wordText').classList.remove('word-animate');
                    state.currentWordPlayed++;
                    updatePlayProgress();
                    
                    if (state.currentWordPlayed < state.currentPlayCount && state.isLooping) {
                        state.speech.speak(utterance);
                    } else {
                        resolve();
                    }
                };
                
                state.speech.speak(utterance);
            });
        }

        // 更新控制按钮状态
        function updateControlButtonState() {
            const controlBtn = document.getElementById('controlBtn');
            if (state.isLooping) {
                controlBtn.className = 'btn-control bg-running text-white hover:bg-running/90';
                controlBtn.innerHTML = '<i class="fa fa-pause"></i><span>暂停循环播放</span>';
            } else {
                controlBtn.className = 'btn-control bg-accent text-white hover:bg-accent/90';
                controlBtn.innerHTML = '<i class="fa fa-play"></i><span>开始循环播放</span>';
            }
        }

        // 恢复上次学习状态
        async function restoreLastStudyState() {
            const lastState = await getLastStudyState();
            if (!lastState) {
                // 无记录时使用默认值
                if (state.chapters.length > 0) {
                    await selectChapter(state.chapters[0]);
                }
                state.currentPlayCount = 1;
                return;
            }
            
            // 恢复章节（检查章节是否存在）
            if (state.chapters.includes(lastState.chapter)) {
                await selectChapter(lastState.chapter);
                
                // 恢复单词索引（检查索引是否有效）
                if (lastState.wordIndex >= 0 && lastState.wordIndex < state.currentChapterWords.length) {
                    state.currentWordIndex = lastState.wordIndex;
                    showWord(state.currentChapterWords[state.currentWordIndex], state.currentWordIndex);
                }
            } else {
                // 章节不存在时使用默认章节
                if (state.chapters.length > 0) {
                    await selectChapter(state.chapters[0]);
                }
            }
            
            // 恢复播放次数
            const validCounts = [1, 3, 6, 12, 25];
            state.currentPlayCount = validCounts.includes(lastState.playCount) 
                ? lastState.playCount 
                : 1;
        }

        // 获取上次学习状态
        function getLastStudyState() {
            return new Promise((resolve) => {
                const transaction = state.db.transaction('studyState', 'readonly');
                const store = transaction.objectStore('studyState');
                const request = store.get('lastStudyState');
                
                request.onsuccess = () => resolve(request.result || null);
                request.onerror = () => resolve(null);
            });
        }

        // 保存当前学习状态（页面关闭时）
        function saveCurrentStudyState() {
            if (!state.db) return;
            
            const currentState = {
                id: 'lastStudyState',
                chapter: state.currentChapter,
                wordIndex: state.currentWordIndex,
                playCount: state.currentPlayCount
            };
            
            const transaction = state.db.transaction('studyState', 'readwrite');
            const store = transaction.objectStore('studyState');
            store.put(currentState);
        }

        // 绑定页面关闭事件
        function bindBeforeUnloadEvent() {
            window.addEventListener('beforeunload', () => {
                saveCurrentStudyState();
                state.speech.cancel();
            });
        }

        // 绑定其他事件
        function bindEvents() {
            // 单词导航按钮
            document.getElementById('prevWordBtn').addEventListener('click', goToPrevWord);
            document.getElementById('nextWordBtn').addEventListener('click', goToNextWord);
            
            // 播放次数按钮
            document.querySelectorAll('.play-count-btn').forEach(btn => {
                btn.addEventListener('click', () => setActivePlayCount(parseInt(btn.dataset.count)));
            });
            
            // 合并的控制按钮
            document.getElementById('controlBtn').addEventListener('click', togglePlayPause);
            
            // 初始化数据库按钮
            document.getElementById('initDBBtn').addEventListener('click', manualInitDB);
            
            // 弹窗相关事件
            document.getElementById('showChapterBtn').addEventListener('click', openChapterModal);
            document.getElementById('closeChapterModal').addEventListener('click', closeChapterModal);
            // 点击遮罩关闭弹窗
            document.getElementById('chapterModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('chapterModal')) {
                    closeChapterModal();
                }
            });
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>